name: PR Preview Cleanup

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  cleanup-preview:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
    - name: Setup Fly CLI
      uses: superfly/flyctl-actions/setup-flyctl@master
    
    - name: Cleanup Fly.io app
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      run: |
        PR_NUMBER="${{ github.event.number }}"
        APP_NAME="pr-${PR_NUMBER}-futuredebrief"
        
        echo "Cleaning up preview app: ${APP_NAME}"
        
        # Check if app exists before trying to destroy it
        if flyctl apps list | grep -q "^${APP_NAME}"; then
          echo "Destroying app: ${APP_NAME}"
          flyctl apps destroy "${APP_NAME}" --yes
          echo "‚úÖ Successfully destroyed preview app: ${APP_NAME}"
        else
          echo "‚ÑπÔ∏è  App ${APP_NAME} not found, already cleaned up or never existed"
        fi
    
    - name: Post cleanup confirmation comment
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = ${{ github.event.number }};
          const appName = `pr-${prNumber}-futuredebrief`;
          
          const commentBody = `## üßπ PR Preview Cleaned Up
          
          The preview environment for this PR has been automatically cleaned up.
          
          **üìã Details:**
          - **App Name:** \`${appName}\`
          - **PR:** #${prNumber}
          - **Status:** Destroyed
          
          ---
          *Resources have been freed up. Thank you for your contribution!*`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: commentBody
          });
    
    - name: Handle cleanup failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = ${{ github.event.number }};
          const appName = `pr-${prNumber}-futuredebrief`;
          
          const errorComment = `## ‚ö†Ô∏è PR Preview Cleanup Issue
          
          There was an issue cleaning up the preview environment automatically.
          
          **üìã Details:**
          - **App Name:** \`${appName}\`
          - **PR:** #${prNumber}
          - **Issue:** Cleanup process encountered an error
          
          The preview environment may need manual cleanup. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.
          
          ---
          *This is likely a temporary issue and doesn't affect the main codebase.*`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: errorComment
          });